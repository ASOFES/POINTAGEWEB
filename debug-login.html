<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Connexion TimeSheet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #1976D2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565C0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üîç Debug Connexion TimeSheet</h1>
    
    <div class="debug-section">
        <h3>üîê Test de Connexion D√©taill√©</h3>
        <button onclick="testFullLogin()">Tester Connexion Compl√®te</button>
        <button onclick="checkLocalStorage()">V√©rifier LocalStorage</button>
        <button onclick="clearStorage()">Nettoyer Storage</button>
        <div id="loginLog" class="log"></div>
    </div>

    <div class="debug-section">
        <h3>üë§ Test Utilisateur</h3>
        <button onclick="testUserLoad()">Tester Chargement Utilisateur</button>
        <div id="userLog" class="log"></div>
    </div>

    <div class="debug-section">
        <h3>üîç √âtat Actuel</h3>
        <button onclick="showCurrentState()">Afficher √âtat</button>
        <div id="stateLog" class="log"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://timesheetapp.azurewebsites.net/api';
        let authToken = null;

        function log(message, type = 'info', target = 'loginLog') {
            const logDiv = document.getElementById(target);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        async function testFullLogin() {
            const logDiv = document.getElementById('loginLog');
            logDiv.innerHTML = '';
            
            log('üöÄ D√©but du test de connexion compl√®te', 'info');
            
            try {
                // √âtape 1: Connexion
                log('üì° Tentative de connexion...', 'info');
                const response = await fetch(`${API_BASE_URL}/Auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'Test@test.com',
                        password: 'test123'
                    })
                });

                const data = await response.json();
                log(`üìä R√©ponse serveur: ${response.status} ${response.statusText}`, 'info');
                log(`üìã Donn√©es re√ßues: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (response.ok) {
                    authToken = data.token;
                    log('‚úÖ Connexion r√©ussie', 'success');
                    log(`üîë Token re√ßu: ${data.token ? 'Oui' : 'Non'}`, 'info');
                    log(`üë§ User re√ßu: ${data.user ? 'Oui' : 'Non'}`, 'info');
                    
                    // √âtape 2: Sauvegarder en localStorage
                    log('üíæ Sauvegarde en localStorage...', 'info');
                    localStorage.setItem('timesheet_token', data.token || '');
                    localStorage.setItem('timesheet_user', JSON.stringify(data.user || {}));
                    log('‚úÖ Donn√©es sauvegard√©es', 'success');
                    
                    // √âtape 3: V√©rifier la sauvegarde
                    log('üîç V√©rification localStorage...', 'info');
                    const savedToken = localStorage.getItem('timesheet_token');
                    const savedUser = localStorage.getItem('timesheet_user');
                    log(`üîë Token sauvegard√©: ${savedToken ? 'Oui' : 'Non'}`, savedToken ? 'success' : 'error');
                    log(`üë§ User sauvegard√©: ${savedUser ? 'Oui' : 'Non'}`, savedUser ? 'success' : 'error');
                    
                    // √âtape 4: Test de validation
                    log('üîê Test de validation du token...', 'info');
                    await testTokenValidation();
                    
                } else {
                    log(`‚ùå Erreur de connexion: ${response.status}`, 'error');
                    log(`üìã Erreur d√©taill√©e: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`, 'error');
            }
        }

        async function testTokenValidation() {
            try {
                const token = localStorage.getItem('timesheet_token');
                if (!token) {
                    log('‚ùå Pas de token √† valider', 'error');
                    return;
                }

                log('üì° Test validation token...', 'info');
                const response = await fetch(`${API_BASE_URL}/Auth/validate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`üìä R√©ponse validation: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    log('‚úÖ Token valide', 'success');
                } else {
                    log('‚ùå Token invalide', 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur validation: ${error.message}`, 'error');
            }
        }

        async function testUserLoad() {
            const logDiv = document.getElementById('userLog');
            logDiv.innerHTML = '';
            
            log('üë§ Test de chargement utilisateur', 'info', 'userLog');
            
            try {
                const token = localStorage.getItem('timesheet_token');
                if (!token) {
                    log('‚ùå Pas de token disponible', 'error', 'userLog');
                    return;
                }

                log('üì° R√©cup√©ration utilisateur...', 'info', 'userLog');
                const response = await fetch(`${API_BASE_URL}/Auth/users/1`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                log(`üìä R√©ponse utilisateur: ${response.status} ${response.statusText}`, 'info', 'userLog');
                log(`üìã Donn√©es utilisateur: ${JSON.stringify(data, null, 2)}`, 'info', 'userLog');
                
                if (response.ok) {
                    log('‚úÖ Utilisateur r√©cup√©r√© avec succ√®s', 'success', 'userLog');
                } else {
                    log('‚ùå Erreur r√©cup√©ration utilisateur', 'error', 'userLog');
                }
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error', 'userLog');
            }
        }

        function checkLocalStorage() {
            const logDiv = document.getElementById('loginLog');
            logDiv.innerHTML = '';
            
            log('üîç V√©rification localStorage', 'info');
            
            const token = localStorage.getItem('timesheet_token');
            const user = localStorage.getItem('timesheet_user');
            
            log(`üîë Token pr√©sent: ${token ? 'Oui' : 'Non'}`, token ? 'success' : 'error');
            log(`üë§ User pr√©sent: ${user ? 'Oui' : 'Non'}`, user ? 'success' : 'error');
            
            if (token) {
                log(`üîë Token: ${token.substring(0, 20)}...`, 'info');
            }
            
            if (user) {
                try {
                    const userObj = JSON.parse(user);
                    log(`üë§ User: ${JSON.stringify(userObj, null, 2)}`, 'info');
                } catch (e) {
                    log(`‚ùå Erreur parsing user: ${e.message}`, 'error');
                }
            }
        }

        function clearStorage() {
            localStorage.removeItem('timesheet_token');
            localStorage.removeItem('timesheet_user');
            log('üßπ Storage nettoy√©', 'warning');
        }

        function showCurrentState() {
            const logDiv = document.getElementById('stateLog');
            logDiv.innerHTML = '';
            
            log('üìä √âtat actuel de l\'application', 'info', 'stateLog');
            
            // V√©rifier localStorage
            const token = localStorage.getItem('timesheet_token');
            const user = localStorage.getItem('timesheet_user');
            
            log(`üîë Token: ${token ? 'Pr√©sent' : 'Absent'}`, token ? 'success' : 'error', 'stateLog');
            log(`üë§ User: ${user ? 'Pr√©sent' : 'Absent'}`, user ? 'success' : 'error', 'stateLog');
            
            // V√©rifier l'URL actuelle
            log(`üåê URL actuelle: ${window.location.href}`, 'info', 'stateLog');
            log(`üîí HTTPS: ${window.location.protocol === 'https:' ? 'Oui' : 'Non'}`, 'info', 'stateLog');
            
            // V√©rifier les cookies
            log(`üç™ Cookies: ${document.cookie ? 'Pr√©sents' : 'Aucun'}`, 'info', 'stateLog');
            
            // V√©rifier les permissions
            if (navigator.permissions) {
                navigator.permissions.query({name: 'camera'}).then(result => {
                    log(`üì∑ Permission cam√©ra: ${result.state}`, 'info', 'stateLog');
                });
            }
        }
    </script>
</body>
</html>
