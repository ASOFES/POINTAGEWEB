<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TimeSheet App - Version Simple</title>
  
  <style>
    /* CSS ultra-compatible pour tous navigateurs */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #667eea;
      color: #333;
      padding: 10px;
      min-height: 100vh;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header {
      background-color: #667eea;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .header h1 {
      font-size: 18px;
      margin: 0;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
    }

    .btn:hover {
      background-color: #5a6fd8;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }

    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background-color: #cce7ff;
      color: #004085;
      border: 1px solid #99d3ff;
    }

    .login-form {
      display: block;
    }

    .app-content {
      display: none;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    .debug {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      max-height: 100px;
      overflow-y: auto;
    }

    .nav-simple {
      display: flex;
      margin-bottom: 20px;
    }

    .nav-simple button {
      flex: 1;
      padding: 10px;
      border: 1px solid #667eea;
      background: white;
      color: #667eea;
      margin: 0 2px;
      border-radius: 5px;
      cursor: pointer;
    }

    .nav-simple button.active {
      background: #667eea;
      color: white;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Debug visible -->
    <div id="debugConsole" class="debug">🔍 Chargement...</div>

    <!-- Formulaire de connexion -->
    <div id="loginSection" class="login-form">
      <div class="header">
        <h1>🔐 Connexion TimeSheet</h1>
      </div>
      
      <div id="loginStatus" class="status info">
        Entrez vos identifiants
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="email">📧 Email :</label>
          <input type="email" id="email" value="admin@asofes.cd" required>
        </div>
        
        <div class="form-group">
          <label for="password">🔒 Mot de passe :</label>
          <input type="password" id="password" value="admin123" required>
        </div>
        
        <button type="submit" class="btn">🚀 Se connecter</button>
      </form>
    </div>

    <!-- Application après connexion -->
    <div id="appSection" class="app-content">
      <div class="header">
        <h1>⏰ TimeSheet App</h1>
        <div style="font-size: 12px; margin-top: 5px;">
          <span id="userDisplay">Utilisateur connecté</span>
          <button onclick="logout()" style="float: right; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 3px;">🚪 Déconnexion</button>
        </div>
      </div>

      <!-- Navigation simple -->
      <div class="nav-simple">
        <button onclick="showSection('dashboard')" class="active" id="dashBtn">🏠 Accueil</button>
        <button onclick="showSection('manual')" id="manualBtn">✏️ Manuel</button>
        <button onclick="showSection('history')" id="historyBtn">📊 Historique</button>
      </div>

      <!-- Section Dashboard -->
      <div id="dashboard" class="section active">
        <div class="status info">
          🏠 Tableau de bord - Choisissez une action
        </div>
        <button onclick="showSection('manual')" class="btn">✏️ Pointage manuel</button>
        <button onclick="showSection('history')" class="btn">📊 Voir l'historique</button>
      </div>

      <!-- Section Pointage Manuel -->
      <div id="manual" class="section">
        <div class="status info">
          ✏️ Saisissez le code QR manuellement
        </div>
        
        <div class="form-group">
          <label for="qrInput">🎯 Code QR :</label>
          <input type="text" id="qrInput" placeholder="Ex: 1|2|3" style="font-family: monospace;">
        </div>
        
        <button onclick="processManualQR()" class="btn">✅ Valider le pointage</button>
        
        <div id="manualStatus" class="status info hidden">
          Prêt pour saisie manuelle
        </div>
      </div>

      <!-- Section Historique -->
      <div id="history" class="section">
        <div class="status info">
          📊 Derniers pointages
        </div>
        <button onclick="loadHistory()" class="btn">🔄 Actualiser</button>
        <div id="historyContent">
          <p style="text-align: center; color: #666; padding: 20px;">
            Cliquez sur "Actualiser" pour charger l'historique
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let currentUser = null;
    let currentToken = null;
    
    // Fonction de debug
    function debugLog(message) {
      console.log(message);
      const debugEl = document.getElementById('debugConsole');
      if (debugEl) {
        const now = new Date().toLocaleTimeString();
        debugEl.innerHTML = now + ': ' + message + '<br>' + debugEl.innerHTML;
        // Garder seulement les 5 dernières lignes
        const lines = debugEl.innerHTML.split('<br>');
        if (lines.length > 6) {
          debugEl.innerHTML = lines.slice(0, 6).join('<br>');
        }
      }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('✅ Page chargée');
      debugLog('📱 Device: ' + navigator.userAgent.substring(0, 30) + '...');
      debugLog('📐 Écran: ' + screen.width + 'x' + screen.height);
      
      // Vérifier si on a déjà un token
      const savedToken = localStorage.getItem('authToken');
      const savedUser = localStorage.getItem('userData');
      
      if (savedToken && savedUser) {
        debugLog('🔑 Token trouvé, tentative connexion auto');
        currentToken = savedToken;
        currentUser = JSON.parse(savedUser);
        showApp();
      } else {
        debugLog('🔐 Pas de token, affichage connexion');
      }
    });

    // Gestion du formulaire de connexion
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      debugLog('🚀 Tentative de connexion...');
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const statusEl = document.getElementById('loginStatus');
      
      statusEl.textContent = '⏳ Connexion en cours...';
      statusEl.className = 'status info';
      
      try {
        const response = await fetch('https://timesheetapp.azurewebsites.net/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            password: password
          })
        });
        
        debugLog('📡 Réponse serveur: ' + response.status);
        
        if (response.ok) {
          const data = await response.json();
          currentToken = data.token;
          currentUser = data.user;
          
          // Sauvegarder
          localStorage.setItem('authToken', currentToken);
          localStorage.setItem('userData', JSON.stringify(currentUser));
          
          debugLog('✅ Connexion réussie: ' + currentUser.displayName);
          statusEl.textContent = '✅ Connexion réussie !';
          statusEl.className = 'status success';
          
          setTimeout(showApp, 1000);
        } else {
          const errorData = await response.json();
          debugLog('❌ Erreur login: ' + errorData.message);
          statusEl.textContent = '❌ ' + (errorData.message || 'Erreur de connexion');
          statusEl.className = 'status error';
        }
      } catch (error) {
        debugLog('❌ Erreur réseau: ' + error.message);
        statusEl.textContent = '❌ Erreur de connexion réseau';
        statusEl.className = 'status error';
      }
    });

    // Afficher l'application
    function showApp() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      document.getElementById('userDisplay').textContent = currentUser.displayName || 'Utilisateur';
      debugLog('🏠 Application affichée');
    }

    // Navigation entre sections
    function showSection(sectionName) {
      debugLog('📱 Navigation vers: ' + sectionName);
      
      // Cacher toutes les sections
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => section.classList.remove('active'));
      
      // Désactiver tous les boutons
      const buttons = document.querySelectorAll('.nav-simple button');
      buttons.forEach(btn => btn.classList.remove('active'));
      
      // Afficher la section demandée
      const targetSection = document.getElementById(sectionName);
      if (targetSection) {
        targetSection.classList.add('active');
      }
      
      // Activer le bon bouton
      if (sectionName === 'dashboard') {
        document.getElementById('dashBtn').classList.add('active');
      } else if (sectionName === 'manual') {
        document.getElementById('manualBtn').classList.add('active');
      } else if (sectionName === 'history') {
        document.getElementById('historyBtn').classList.add('active');
      }
    }

    // Traitement pointage manuel
    async function processManualQR() {
      const qrInput = document.getElementById('qrInput').value.trim();
      const statusEl = document.getElementById('manualStatus');
      
      if (!qrInput) {
        statusEl.textContent = '❌ Veuillez saisir un code QR';
        statusEl.className = 'status error';
        statusEl.classList.remove('hidden');
        return;
      }
      
      debugLog('🎯 Traitement QR: ' + qrInput);
      statusEl.textContent = '⏳ Traitement en cours...';
      statusEl.className = 'status info';
      statusEl.classList.remove('hidden');
      
      try {
        const parts = qrInput.split('|');
        if (parts.length < 3) {
          throw new Error('Format QR invalide (attendu: site|planning|type)');
        }
        
        const [siteId, planningId, timesheetTypeId] = parts;
        
        const payload = {
          site_id: parseInt(siteId),
          planning_id: parseInt(planningId),
          timesheet_type_id: parseInt(timesheetTypeId),
          unique_code: 'WEB-' + Date.now(),
          details: JSON.stringify({
            uid: currentUser.id,
            un: currentUser.displayName,
            pid: parseInt(planningId),
            ts: Date.now(),
            lat: 0.0,
            lng: 0.0,
            method: 'manual'
          })
        };
        
        const response = await fetch('https://timesheetapp.azurewebsites.net/api/timesheets', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + currentToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        debugLog('📡 Réponse pointage: ' + response.status);
        
        if (response.ok) {
          const result = await response.json();
          debugLog('✅ Pointage créé: ID ' + result.id);
          statusEl.textContent = '✅ Pointage enregistré avec succès !';
          statusEl.className = 'status success';
          document.getElementById('qrInput').value = '';
        } else {
          const errorData = await response.json();
          debugLog('❌ Erreur pointage: ' + errorData.message);
          statusEl.textContent = '❌ ' + (errorData.message || 'Erreur lors du pointage');
          statusEl.className = 'status error';
        }
      } catch (error) {
        debugLog('❌ Erreur: ' + error.message);
        statusEl.textContent = '❌ ' + error.message;
        statusEl.className = 'status error';
      }
    }

    // Chargement historique
    async function loadHistory() {
      debugLog('📊 Chargement historique...');
      const contentEl = document.getElementById('historyContent');
      
      contentEl.innerHTML = '<p style="text-align: center;">⏳ Chargement...</p>';
      
      try {
        const response = await fetch('https://timesheetapp.azurewebsites.net/api/timesheets/user/' + currentUser.id, {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + currentToken,
            'Content-Type': 'application/json'
          }
        });
        
        debugLog('📡 Réponse historique: ' + response.status);
        
        if (response.ok) {
          const timesheets = await response.json();
          debugLog('📋 ' + timesheets.length + ' pointages trouvés');
          
          if (timesheets.length === 0) {
            contentEl.innerHTML = '<p style="text-align: center; color: #666;">Aucun pointage trouvé</p>';
          } else {
            let html = '<div style="font-size: 12px;">';
            timesheets.slice(0, 10).forEach(ts => {
              const date = new Date(ts.created_at).toLocaleString('fr-FR');
              html += '<div style="border: 1px solid #ddd; margin: 5px 0; padding: 8px; border-radius: 5px;">';
              html += '<strong>📅 ' + date + '</strong><br>';
              html += '🏷️ Code: ' + (ts.unique_code || 'N/A') + '<br>';
              html += '⏰ Type: ' + (ts.timesheet_type_id || 'N/A') + '<br>';
              html += '✅ Statut: ' + (ts.status || 'Enregistré');
              html += '</div>';
            });
            html += '</div>';
            contentEl.innerHTML = html;
          }
        } else {
          contentEl.innerHTML = '<p style="text-align: center; color: red;">❌ Erreur de chargement</p>';
        }
      } catch (error) {
        debugLog('❌ Erreur historique: ' + error.message);
        contentEl.innerHTML = '<p style="text-align: center; color: red;">❌ ' + error.message + '</p>';
      }
    }

    // Déconnexion
    function logout() {
      debugLog('🚪 Déconnexion');
      currentUser = null;
      currentToken = null;
      localStorage.removeItem('authToken');
      localStorage.removeItem('userData');
      
      document.getElementById('appSection').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      
      // Reset du formulaire
      document.getElementById('loginStatus').textContent = 'Entrez vos identifiants';
      document.getElementById('loginStatus').className = 'status info';
    }

    // Gestion des erreurs globales
    window.onerror = function(msg, url, line, col, error) {
      debugLog('❌ JS Error: ' + msg);
      return false;
    };
  </script>
</body>
</html>
